# 项目进度跟踪

## 总目标

基于 ROS2 (Humble) 和 Qt 开发机器人导航监控界面，实现以下功能：

1. **机器人状态信息显示**
   - 电池电量（电压和百分比）
   - 位置信息（在已有地图实时显示位置和姿态）
   - 启动和停止信息
   - 系统运行时间

2. **机器人日志信息**
   - 在错误或撞机时显示和查询机器人日志信息

3. **机器人导航状态信息**
   - 屏幕点击导航到指定位置
   - 显示导航状态（成功/失败/报警）

4. **机器人用户权限管理**
   - 设置不同用户权限和密码
   - 授权用户进行指定操作

5. **撞机后恢复算法**
   - 沿撞机方向后退 20 厘米
   - 或根据撞机时周围环境自主退让到安全区域

---

## 已完成部分

### 一、多线程架构设计 ✅

已完成线程划分和实现：

| 线程 | 职责 | 状态 |
|------|------|------|
| 主线程 | UI显示和用户交互 | ✅ 框架完成 |
| RobotStatusThread | 电池、位置、里程计、系统时间 | ✅ 实现 |
| NavStatusThread | 导航状态、反馈、路径 | ✅ 实现 |
| SystemMonitorThread | 日志、诊断、碰撞检测 | ✅ 实现 |
| LogThread | 日志文件管理 | ✅ 实现 |
| InfoThread | 信息处理线程 | ✅ 实现 |

### 二、核心文件结构 ✅

```
RenWu/
├── basethread.h/cpp              # 线程基类 ✅
├── roscontextmanager.h/cpp        # ROS2上下文管理 ✅
├── threadsafequeue.h              # 线程安全队列 ✅
├── robotstatusthread.h/cpp        # 机器人状态线程 ✅
├── navstatusthread.h/cpp          # 导航状态线程 ✅
├── systemmonitorthread.h/cpp      # 系统监控线程 ✅
├── logthread.h/cpp                # 日志线程 ✅
├── infothread.h/cpp               # 信息处理线程 ✅
├── logstorageengine.h/cpp         # 日志存储引擎 ✅
├── logtablemodel.h/cpp            # 日志表格模型 ✅
├── logfilterproxymodel.h/cpp      # 日志过滤代理模型 ✅
├── logquerytask.h/cpp             # 日志查询任务 ✅
├── mainwindow.h/cpp               # 主窗口 ✅
└── mainwindow.ui                  # UI界面（日志查询部分完成）
```

### 三、RobotStatusThread 实现 ✅

已订阅的话题和处理功能：

| 话题 | 消息类型 | 信号 | 状态 |
|------|----------|------|------|
| `/PowerVoltage` | `std_msgs::msg::Float32` | `batteryStatusReceived` | ✅ |
| `/amcl_pose` | `geometry_msgs::msg::PoseWithCovarianceStamped` | `positionReceived` | ✅ |
| `/odom` | `nav_msgs::msg::Odometry` | `odometryReceived` | ✅ |
| `/time_reference` | `sensor_msgs::msg::TimeReference` | `systemTimeReceived` | ✅ |
| `/diagnostics` | `diagnostic_msgs::msg::DiagnosticArray` | `diagnosticsReceived` | ✅ |

### 四、NavStatusThread 实现 ✅

已订阅的话题和处理功能：

| 话题 | 消息类型 | 信号 | 状态 |
|------|----------|------|------|
| `/navigate_to_pose/_action/status` | `action_msgs::msg::GoalStatusArray` | `navigationStatusReceived` | ✅ |
| `/navigate_to_pose/_action/feedback` | `nav2_msgs::action::NavigateToPose::Feedback` | `navigationFeedbackReceived` | ✅ |
| `/plan` | `nav_msgs::msg::Path` | `navigationPathReceived` | ✅ |

### 五、SystemMonitorThread 实现 ✅

已订阅的话题和处理功能：

| 话题 | 消息类型 | 信号 | 状态 |
|------|----------|------|------|
| `/rosout` | `rcl_interfaces::msg::Log` | `logMessageReceived` | ✅ |
| `/diagnostics` | `diagnostic_msgs::msg::DiagnosticArray` | `diagnosticsReceived` | ✅ |
| `/mobile_base/sensors/bumper_pointcloud` | `sensor_msgs::msg::PointCloud2` | `collisionDetected` | ✅ |
| `/behavior_tree_log` | `nav2_msgs::msg::BehaviorTreeLog` | `behaviorTreeLogReceived` | ✅ |

### 六、数据层实现 ✅

已实现的数据存储和查询功能：

| 模块 | 功能 | 状态 |
|------|------|------|
| LogStorageEngine | SQLite日志存储引擎 | ✅ |
| LogTableModel | 日志表格数据模型 | ✅ |
| LogFilterProxyModel | 日志过滤代理模型 | ✅ |
| LogQueryTask | 异步日志查询任务 | ✅ |

**日志存储引擎特性**：
- 支持批量插入日志（BATCH_INSERT_SIZE = 100）
- 支持多条件查询（时间范围、级别、来源、关键词）
- 支持日志清理和数据库优化
- 使用QReadWriteLock保证线程安全

**日志查询功能**：
- 时间范围过滤
- 日志级别过滤（DEBUG/INFO/WARNING/ERROR/FATAL）
- 来源节点过滤
- 关键词搜索
- 异步查询（使用QThreadPool）

### 七、线程间通信 ✅

- 工作线程 → 主线程的信号连接 ✅
- 工作线程 → LogThread 的日志转发 ✅
- 线程启动/停止顺序管理 ✅
- 线程安全队列（ThreadSafeQueue）✅

---

## 需求文档符合性审查结果

### 审查日期
2026-01-12

### 总体符合度
**约 65%**

### 符合度详细评估

| 类别 | 符合度 | 说明 |
|------|--------|------|
| **系统架构** | 85% | 三层架构基本符合，但表示层不完整 |
| **ROS2集成** | 90% | 通信代理模块设计良好，但缺少Action客户端 |
| **多线程并发** | 95% | 线程模型设计优秀，符合需求文档要求 |
| **数据层** | 90% | 日志存储引擎完善，支持高效查询 |
| **UI设计** | 30% | 缺少地图显示、导航交互等核心UI组件 |
| **功能完整性** | 40% | 缺少地图可视化、导航控制、用户管理、撞机恢复 |

### ✅ 符合要求的部分

#### 1. 系统架构设计
- ✅ 三层架构（表示层、业务逻辑层、数据层）
- ✅ 独立线程Spin模式（BaseThread在独立线程中执行rclcpp::spin）
- ✅ 线程隔离（Qt主线程 + 4个工作线程）
- ✅ 信号槽通信（跨线程通信）

#### 2. ROS2通信代理模块
- ✅ 封装ROS2通信实体（各线程分别封装订阅）
- ✅ 数据转换与转发（在回调中发射Qt信号）
- ✅ 线程安全（使用ThreadSafeQueue和信号槽机制）

#### 3. 多任务并发模型
- ✅ ROS2通信使用自定义QThread
- ✅ 日志查询使用线程池（QThreadPool + QRunnable）

#### 4. 数据层设计
- ✅ 日志存储引擎（SQLite）
- ✅ 日志查询功能（多条件过滤）
- ✅ 批量插入日志

### ❌ 不符合或缺失的部分

#### 1. 地图显示与可视化（严重缺失）
- ❌ 没有订阅 `/map` 话题
- ❌ 没有OccupancyGrid解析和转换
- ❌ 没有地图显示组件
- ❌ 没有地图缓存管理器

#### 2. 机器人位置可视化（严重缺失）
- ❌ 虽然订阅了 `/amcl_pose`，但没有在地图上可视化
- ❌ 没有显示机器人的方向箭头或图标
- ❌ 没有实时更新可视化

#### 3. 地图交互功能（严重缺失）
- ❌ 没有实现点击地图发送导航目标
- ❌ 没有地图缩放/拖拽功能
- ❌ 没有导航Action客户端（只有订阅，没有发送）

#### 4. UI技术栈选择（不符合推荐）
- ❌ 使用Qt Widgets，而需求文档推荐使用QML (Qt Quick)
- ❌ 没有实现地图渲染方案

#### 5. 导航控制功能（部分缺失）
- ✅ 导航状态订阅
- ✅ 导航反馈订阅
- ❌ 没有实现发送导航目标的Action客户端

#### 6. 用户权限管理（完全缺失）
- ❌ 没有登录界面
- ❌ 没有权限级别管理
- ❌ 没有用户增删改查功能

#### 7. 撞机后恢复算法（完全缺失）
- ✅ 碰撞检测
- ❌ 没有实现后退20cm的逻辑
- ❌ 没有实现自主退让功能

### ⚠️ 部分符合或需要改进的部分

#### 1. UI状态定时更新
- ⚠️ 直接在回调中更新，可能导致高频数据时UI更新过于频繁
- 建议：对高频数据使用QTimer进行降频处理

#### 2. 日志查询实现
- ✅ 使用了QThreadPool
- ✅ LogQueryTask继承QRunnable
- ✅ 符合需求文档要求

---

## 下一步任务

### 优先级 P0（核心功能 - 必须实现）

#### 1. 地图显示和可视化
- [ ] 订阅 `/map` 话题（nav_msgs::msg::OccupancyGrid）
- [ ] 实现OccupancyGrid到QImage的转换
- [ ] 在UI中添加地图显示组件
  - [ ] 使用QGraphicsView或QML Canvas
  - [ ] 实现地图渲染（未知区域灰色，空闲白色，占用黑色）
- [ ] 实现地图缓存管理器
- [ ] 支持地图加载（读取.yaml和.pgm文件）

#### 2. 机器人位置可视化
- [ ] 在地图上绘制机器人位置（使用 `/amcl_pose` 数据）
- [ ] 使用三角形或箭头表示机器人方向
- [ ] 实现实时更新（建议降频到30-60Hz）
- [ ] 添加机器人图标或标记

#### 3. 导航交互功能
- [ ] 创建 `/navigate_to_pose` Action Client
- [ ] 实现点击地图获取坐标
- [ ] 实现点击地图发送导航目标
- [ ] 添加地图缩放功能（鼠标滚轮）
- [ ] 添加地图拖拽功能（鼠标左键拖动）
- [ ] 显示导航路径（使用 `/plan` 数据）

#### 4. UI界面完善
- [ ] 添加状态显示控件：
  - [ ] 电池电量显示（电压 + 百分比）
  - [ ] 位置信息显示（x, y, yaw）
  - [ ] 系统时间显示
  - [ ] 运行状态指示
- [ ] 添加导航控制面板
- [ ] 添加日志显示区域（已完成查询功能）
- [ ] 实现槽函数与UI控件的绑定

### 优先级 P1（重要功能）

#### 5. 用户权限管理
- [ ] 设计用户数据结构（用户名、密码、权限级别）
- [ ] 实现登录界面
- [ ] 实现用户认证逻辑
- [ ] 根据权限级别控制功能访问
- [ ] 添加用户管理界面（创建/删除用户、修改密码）

#### 6. 撞机后恢复算法
- [ ] 检测碰撞事件（接收 `collisionDetected` 信号）
- [ ] 实现后退恢复算法：
  - [ ] 获取撞机方向
  - [ ] 发送 `/cmd_vel` 命令后退 20cm
- [ ] 实现自主退让算法（可选）：
  - [ ] 分析周围环境（使用激光雷达数据）
  - [ ] 寻找安全区域
  - [ ] 规划退让路径

#### 7. UI更新优化
- [ ] 对高频数据（里程计）使用QTimer进行降频处理
- [ ] 实现批量更新UI
- [ ] 限制UI刷新率到30-60Hz

### 优先级 P2（优化和改进）

#### 8. 考虑迁移到QML
- [ ] 按照需求文档推荐，使用Qt Quick获得更好的性能和交互体验
- [ ] 重构UI为QML界面
- [ ] 使用QML Canvas或Image元素显示地图

#### 9. 系统测试
- [ ] 在 Gazebo 仿真环境中测试所有功能
- [ ] 在实际机器人平台上测试
- [ ] 性能测试（CPU、内存使用）
- [ ] 长时间运行稳定性测试

#### 10. 用户体验优化
- [ ] 添加启动画面
- [ ] 优化界面响应速度
- [ ] 添加错误提示和帮助信息
- [ ] 支持中英文切换

---

## 技术要点

### ROS2 话题订阅
- 电池电量：`/PowerVoltage`
- 定位：`/amcl_pose`
- 里程计：`/odom`
- 地图：`/map`（待实现）
- 导航状态：`/navigate_to_pose/_action/status`
- 导航反馈：`/navigate_to_pose/_action/feedback`
- 路径规划：`/plan`
- 日志：`/rosout`
- 诊断：`/diagnostics`
- 碰撞检测：`/mobile_base/sensors/bumper_pointcloud`
- 行为树日志：`/behavior_tree_log`

### ROS2 Action/Service
- 导航目标：`/navigate_to_pose/_action` (Action) - 待实现客户端
- 清除代价地图：`/clear_costmap_remote` (Service)

### Qt 技术栈
- Qt 5/6 Widgets
- Qt 信号槽机制（跨线程通信）
- QThread 用于多线程
- QThreadPool 用于异步任务
- QReadWriteLock 用于线程安全
- QPainter 用于地图绘制（待实现）

### 数据存储
- SQLite 数据库（日志存储）
- 支持批量插入和高效查询

---

## 环境信息

- 操作系统：Ubuntu 22.04 (WSL2)
- ROS2 版本：Humble
- Qt 版本：Qt5/Qt6
- 机器人平台：WheelTec
- 编译器：GCC 11
- C++ 标准：C++17

---

## 参考文档

- 需求文档：`/home/w/default_WheelTec_ros2/基于Qt与ROS2 Humble的机器人监控平台：多任务并发与交互设计实践.md`
- 审查日期：2026-01-12
- 总体符合度：约 65%
