# 项目进度跟踪

## 总目标

基于 ROS2 (Humble) 和 Qt 开发机器人导航监控界面，实现以下功能：

1. **机器人状态信息显示**
   - 电池电量（电压和百分比）
   - 位置信息（在已有地图实时显示位置和姿态）
   - 启动和停止信息
   - 系统运行时间

2. **机器人日志信息**
   - 在错误或撞机时显示和查询机器人日志信息

3. **机器人导航状态信息**
   - 屏幕点击导航到指定位置
   - 显示导航状态（成功/失败/报警）

4. **机器人用户权限管理**
   - 设置不同用户权限和密码
   - 授权用户进行指定操作

5. **撞机后恢复算法**
   - 沿撞机方向后退 20 厘米
   - 或根据撞机时周围环境自主退让到安全区域

---

## 已完成部分

### 一、多线程架构设计 ✅

已完成线程划分和实现：

| 线程 | 职责 | 状态 |
|------|------|------|
| 主线程 | UI显示和用户交互 | ✅ 框架完成 |
| RobotStatusThread | 电池、位置、里程计、系统时间 | ✅ 实现 |
| NavStatusThread | 导航状态、反馈、路径 | ✅ 实现 |
| SystemMonitorThread | 日志、诊断、碰撞检测 | ✅ 实现 |
| LogThread | 日志文件管理 | ✅ 实现 |

### 二、核心文件结构 ✅

```
RenWu/
├── basethread.h/cpp              # 线程基类 ✅
├── roscontextmanager.h/cpp        # ROS2上下文管理 ✅
├── threadsafequeue.h              # 线程安全队列 ✅
├── robotstatusthread.h/cpp        # 机器人状态线程 ✅
├── navstatusthread.h/cpp          # 导航状态线程 ✅
├── systemmonitorthread.h/cpp      # 系统监控线程 ✅
├── logthread.h/cpp                # 日志线程 ✅
├── infothread.h/cpp               # 信息处理线程 ✅
├── mainwindow.h/cpp               # 主窗口 ✅
└── mainwindow.ui                  # UI界面（待完善）
```

### 三、RobotStatusThread 实现 ✅

已订阅的话题和处理功能：

| 话题 | 消息类型 | 信号 | 状态 |
|------|----------|------|------|
| `/PowerVoltage` | `std_msgs::msg::Float32` | `batteryStatusReceived` | ✅ |
| `/amcl_pose` | `geometry_msgs::msg::PoseWithCovarianceStamped` | `positionReceived` | ✅ |
| `/odom` | `nav_msgs::msg::Odometry` | `odometryReceived` | ✅ |
| `/time_reference` | `sensor_msgs::msg::TimeReference` | `systemTimeReceived` | ✅ |
| `/diagnostics` | `diagnostic_msgs::msg::DiagnosticArray` | `diagnosticsReceived` | ✅ |

### 四、NavStatusThread 实现 ✅

已订阅的话题和处理功能：

| 话题 | 消息类型 | 信号 | 状态 |
|------|----------|------|------|
| `/navigate_to_pose/_action/status` | `action_msgs::msg::GoalStatusArray` | `navigationStatusReceived` | ✅ |
| `/navigate_to_pose/_action/feedback` | `nav2_msgs::action::NavigateToPose::Feedback` | `navigationFeedbackReceived` | ✅ |
| `/plan` | `nav_msgs::msg::Path` | `navigationPathReceived` | ✅ |

### 五、SystemMonitorThread 实现 ✅

已订阅的话题和处理功能：

| 话题 | 消息类型 | 信号 | 状态 |
|------|----------|------|------|
| `/rosout` | `rcl_interfaces::msg::Log` | `logMessageReceived` | ✅ |
| `/diagnostics` | `diagnostic_msgs::msg::DiagnosticArray` | `diagnosticsReceived` | ✅ |
| `/mobile_base/sensors/bumper_pointcloud` | `sensor_msgs::msg::PointCloud2` | `collisionDetected` | ✅ |
| `/behavior_tree_log` | `nav2_msgs::msg::BehaviorTreeLog` | `behaviorTreeLogReceived` | ✅ |

### 六、线程间通信 ✅

- 工作线程 → 主线程的信号连接 ✅
- 工作线程 → LogThread 的日志转发 ✅
- 线程启动/停止顺序管理 ✅

---

## 下一步任务

### 优先级 P0（核心功能）

#### 1. UI界面设计和实现
- [ ] 设计主界面布局（参考 `mainwindow.ui`）
- [ ] 添加状态显示控件：
  - [ ] 电池电量显示（电压 + 百分比）
  - [ ] 位置信息显示（x, y, yaw）
  - [ ] 系统时间显示
  - [ ] 运行状态指示
- [ ] 添加导航控制：
  - [ ] 地图显示区域（支持点击导航）
  - [ ] 导航状态显示
  - [ ] 导航反馈显示
- [ ] 添加日志显示区域
- [ ] 实现槽函数与UI控件的绑定

#### 2. 地图显示和导航交互
- [ ] 集成地图显示（使用 `ros2_qt_map_display` 或自定义绘制）
- [ ] 实现地图加载功能（读取 `.yaml` 和 `.pgm` 文件）
- [ ] 实现机器人位置在地图上的实时显示
- [ ] 实现点击地图发送导航目标点
- [ ] 添加导航Action客户端（发送 `/navigate_to_pose` 目标）

#### 3. 日志查询功能
- [ ] 实现日志文件读取和解析
- [ ] 添加日志查询界面（时间范围、级别过滤）
- [ ] 实现日志历史记录显示

### 优先级 P1（重要功能）

#### 4. 用户权限管理
- [ ] 设计用户数据结构（用户名、密码、权限级别）
- [ ] 实现登录界面
- [ ] 实现用户认证逻辑
- [ ] 根据权限级别控制功能访问
- [ ] 添加用户管理界面（创建/删除用户、修改密码）

#### 5. 撞机后恢复算法
- [ ] 检测碰撞事件（接收 `collisionDetected` 信号）
- [ ] 实现后退恢复算法：
  - [ ] 获取撞机方向
  - [ ] 发送 `/cmd_vel` 命令后退 20cm
- [ ] 实现自主退让算法（可选）：
  - [ ] 分析周围环境（使用激光雷达数据）
  - [ ] 寻找安全区域
  - [ ] 规划退让路径

### 优先级 P2（优化和测试）

#### 6. 系统测试
- [ ] 在 Gazebo 仿真环境中测试所有功能
- [ ] 在实际机器人平台上测试
- [ ] 性能测试（CPU、内存使用）
- [ ] 长时间运行稳定性测试

#### 7. 用户体验优化
- [ ] 添加启动画面
- [ ] 优化界面响应速度
- [ ] 添加错误提示和帮助信息
- [ ] 支持中英文切换

---

## 技术要点

### ROS2 话题订阅
- 电池电量：`/PowerVoltage`
- 定位：`/amcl_pose`
- 里程计：`/odom`
- 导航状态：`/navigate_to_pose/_action/status`
- 导航反馈：`/navigate_to_pose/_action/feedback`
- 路径规划：`/plan`
- 日志：`/rosout`
- 诊断：`/diagnostics`
- 碰撞检测：`/mobile_base/sensors/bumper_pointcloud`

### ROS2 Action/Service
- 导航目标：`/navigate_to_pose/_action` (Action)
- 清除代价地图：`/clear_costmap_remote` (Service)

### Qt 技术栈
- Qt 5/6 Widgets
- Qt 信号槽机制（跨线程通信）
- QPainter 用于地图绘制
- QThread 用于多线程

---

## 环境信息

- 操作系统：Ubuntu 22.04
- ROS2 版本：Humble
- Qt 版本：待确认
- 机器人平台：WheelTec
