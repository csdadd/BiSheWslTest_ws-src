<!--
  ThreePointTurn 三点掉头行为树配置示例

  此文件展示了如何在Nav2行为树中使用ThreePointTurn恢复行为节点。

  使用方法：
  1. 将此文件复制到 nav2_bt_navigator/behavior_trees/ 目录
  2. 在导航参数文件中设置 default_nav_to_pose_bt_xml 参数指向此文件
  3. 重新编译并启动导航系统
-->
<root main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <RecoveryNode number_of_retries="6" name="NavigateRecovery">
      <PipelineSequence name="NavigateWithReplanning">
        <!-- 路径规划 -->
        <RateController hz="1.0">
          <RecoveryNode number_of_retries="1" name="ComputePathToPose">
            <ComputePathToPose goal="{goal}" path="{path}" planner_id="GridBased"/>
            <ReactiveFallback name="ComputePathToPoseRecoveryFallback">
              <GoalUpdated/>
              <ClearEntireCostmap name="ClearGlobalCostmap-Context"
                                  service_name="global_costmap/clear_entirely_global_costmap"/>
            </ReactiveFallback>
          </RecoveryNode>
        </RateController>

        <!-- 路径跟踪 -->
        <RecoveryNode number_of_retries="1" name="FollowPath">
          <FollowPath path="{path}" controller_id="FollowPath"/>
          <ReactiveFallback name="FollowPathRecoveryFallback">
            <GoalUpdated/>
            <ClearEntireCostmap name="ClearLocalCostmap-Context"
                                service_name="local_costmap/clear_entirely_local_costmap"/>
          </ReactiveFallback>
        </RecoveryNode>
      </PipelineSequence>

      <!-- 恢复行为 -->
      <ReactiveFallback name="RecoveryFallback">
        <GoalUpdated/>
        <RoundRobin name="RecoveryActions">
          <!-- 1. 清除代价地图 -->
          <Sequence name="ClearingActions">
            <ClearEntireCostmap name="ClearLocalCostmap-Subtree"
                                service_name="local_costmap/clear_entirely_local_costmap"/>
            <ClearEntireCostmap name="ClearGlobalCostmap-Subtree"
                                service_name="global_costmap/clear_entirely_global_costmap"/>
          </Sequence>

          <!-- 2. 三点掉头（阿克曼车型专用） -->
          <ThreePointTurn forward_dist="0.75"
                         backward_dist="1.0"
                         max_speed="0.5"
                         max_steering_angle="0.5"/>

          <!-- 3. 原地旋转（非阿克曼车型） -->
          <Spin spin_dist="1.57"/>

          <!-- 4. 等待 -->
          <Wait wait_duration="5"/>

          <!-- 5. 后退 -->
          <BackUp backup_dist="0.15" backup_speed="0.025"/>
        </RoundRobin>
      </ReactiveFallback>
    </RecoveryNode>
  </BehaviorTree>
</root>

<!--
===========================================
参数说明
===========================================

ThreePointTurn 节点参数：
  - forward_dist: 前进距离（米），建议约1.5倍轴距
  - backward_dist: 后退距离（米），建议约2倍轴距
  - max_speed: 最大速度（m/s），建议0.3-0.8
  - max_steering_angle: 最大转向角（弧度），建议0.4-0.6

不同车型的推荐参数：
  mini_akm:    forward_dist="0.5"  backward_dist="0.7"  max_speed="0.4" max_steering_angle="0.55"
  senior_akm:  forward_dist="0.75" backward_dist="1.0"  max_speed="0.5" max_steering_angle="0.5"
  top_akm:     forward_dist="1.0"  backward_dist="1.5"  max_speed="0.6" max_steering_angle="0.45"

===========================================
恢复行为执行顺序
===========================================

当导航失败时，恢复行为按以下顺序执行：

1. ClearingActions - 清除局部和全局代价地图
2. ThreePointTurn  - 执行三点掉头（仅阿克曼车型）
3. Spin            - 原地旋转（非阿克曼车型优先使用）
4. Wait            - 等待5秒
5. BackUp          - 后退0.15米

每个恢复行为执行后，会重新尝试导航。
如果所有恢复行为都失败，则整个导航任务失败。

===========================================
注意事项
===========================================

1. ThreePointTurn 仅适用于阿克曼转向车型
2. 对于差速驱动等可原地旋转的车型，建议移除ThreePointTurn节点
3. 确保有足够的执行空间（建议至少3米 x 3米）
4. 狭窄空间可减小 forward_dist 和 backward_dist 参数
-->
